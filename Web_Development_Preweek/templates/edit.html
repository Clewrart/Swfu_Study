<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta content="" http-equiv="keywords">
    <meta name="description" content="">
    <meta name="applicable-device" content="pc,mobile">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>更新{{post.title}}-{{usernow}}</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.css') }}">
    <link rel="stylesheet" href="../static/css/index.css" type="text/css">
    <link rel="stylesheet" href="../static/css/index2.css" type="text/css">


    <script type="text/javascript" src="../static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../static/js/jquery.SuperSlide.2.1.1.js"></script>
    <script type="text/javascript" src="../static/js/public.js"></script>
    <!-- 菜单js等-->
    <!-- 时间选择js -->
    <script type="text/javascript" src="../static/js/laydate.js"></script>
</head>

<body>
    <!--头部-->
    <div class="topbox bg">
        <div class="wid_main fix">
            <div class="logo l"><img src="../static/images/logo.png" alt="logo" />
                <a href="{{ url_for('search')}}" class="btn btn-warning btn-lg rounded-pill" style="margin-left: 400px">点击进行全局搜索</a>
            </div>

        </div>

    </div>
    <!-- top end -->

    <!-- 主体内容框 -->
    <div class="contentbox wid_main bora_5">
        <div class="content">

            <!-- 导航栏部分 -->
            <div class="top_nav bg bora_5 ovh" style="display: flex;align-items: center;justify-content: center;margin-top:10px">
                <ul class="fix" style="display: flex;align-items: center;justify-content: center">
                    <li class="cur">
                        <a href="{{ url_for('index') }}">首 页</a>
                    </li>
                    <li>
                        <a href="#" class="category-btn" data-category="科技">科技</a>
                    </li>
                    <li>
                        <a href="#" class="category-btn" data-category="教育">教育</a>
                    </li>
                    <li>
                        <a href="#" class="category-btn" data-category="生活">生活</a>
                    </li>
                    {% if not usernow %}
                    <li>
                        <a href="{{ url_for('login') }}">写作</a>
                    </li>
                    {% else %}
                    <li>
                        <a href="{{ url_for('issue') }}">写作</a>
                    </li>
                    {% endif %}
                    <li>
                        {% if not usernow %}
                        <a href="{{ url_for('login') }}">登录/注册</a> {% else %}
                        <li>
                            <a style="color: aquamarine;" href="{{ url_for('manage') }}">管理文章</a>
                        </li>
                        <li>
                            <a href="{{ url_for('logout') }}" style="background-color:salmon;font-size: larger;">退出{{usernow}}</a>
                        </li>
                        {% endif %}
                    </li>
                </ul>
            </div>
            <div class="container mt-5">
                <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
                <h2 class="text-center" style="margin-top: 10px">文章更新</h2>

                <form id="editForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>作者: </label>
                        <input type="text" class="form-control" readonly="readonly" name="username" value="{{ post.username }}">
                    </div>

                    <div class="form-group">
                        <label>分类: </label>
                        <select class="form-control" name="category" id="category" value="{{ post.category }}" required>
                <option value="科技">科技</option>
                <option value="生活">生活</option>
                <option value="教育">教育</option>
            </select>
                    </div>

                    <div class="form-group">
                        <label>标题: </label>
                        <input type="text" class="form-control" name="title" id="title" value="{{ post.title }}" required placeholder="请输入标题">
                    </div>

                    <div class="form-group">
                        <label>内容: </label>
                        <div id="editor" style="height: 300px;background-color: antiquewhite;"></div>
                        <input type="hidden" name="content" required>
                    </div>

                    <div class="form-group">
                        <label>当前主图: </label> {% if post.image %}
                        <img src="data:image/jpeg;base64,{{ post.image }}" alt="原图" style="max-width: 200px; height: auto;"> {% endif %}
                        <input type="file" class="form-control" id="image" name="image"><br>
                        <label>当前附件: </label>
                        {% for attachment in attachments %}
                            <a href="{{ url_for('download', attachment_id=attachment.id) }}" target="_blank">下载 {{ attachment.file_name }}</a>
                            <button class="delete-attachment-btn btn btn-warning mt-3" data-attachment-id="{{ attachment.id }}" data-post-id="{{ post.id }}">删除</button>
<br>
                        {% endfor %}

                        <div class="form-group">
                            <label>上传新增附件: </label>
                            <input type="file" class="form-control" id="file-upload" name="files[]" multiple>
                            <ul id="file-list" style="margin-top: 10px;"></ul>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">更新</button>
                </form>
            </div>
        </div>
    </div>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline'],
            [{
                'list': 'ordered'
            }, {
                'list': 'bullet'
            }],
            [{
                'align': []
            }],
            ['link'],
            ['blockquote', 'code-block'],
            ['image']
        ]
    }
});

    $(document).ready(function() {
        var postContent = `{{ post.content | safe }}`;
        quill.root.innerHTML = postContent; //将后台传递的内容-编辑器
    });

    $('#editForm').submit(function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        var title = $('#title').val();
        var content = quill.root.innerHTML;
        var category = $('#category').val();
        var image = $('#image')[0].files[0];
        var image_base64 = null;
        //图片转换,新图更新
        if (image) {
            var reader = new FileReader();
            reader.onloadend = function() {
                image_base64 = reader.result.split(',')[1];
                update(title, content, category, image_base64, formData);
            };
            reader.readAsDataURL(image);
        } else {
            update(title, content, category, image_base64, formData);
        }
    });

function update(title, content, category, image_base64, formData) {
    $.ajax({
        url: '/edit_post?post_id={{ post.id }}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            title: title,
            content: content,
            category: category,
            image: image_base64
        }),
        success: function(response) {
            if (response.success) {
                //在上传附件后处理db
                uploadfj(formData); //上传附件
                alert(response.message);
                window.location.href = '/manage';
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert('请求失败');
        }
    });
}

//上传附件
function uploadfj(formData) {
    $.ajax({
        url: '/upload_attachments?post_id={{ post.id }}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert('附件处理成功');
                window.location.href = '/manage';
            } else {
                alert('附件上传失败');
            }
        },
        error: function() {
            alert('附件上传失败');
        }
    });
}

//删除附件
$(document).ready(function() {
        $(".delete-attachment-btn").click(function() {
            var attachmentId = $(this).data("attachment-id");
            var postId = $(this).data("post-id");

            if (confirm("确认删除该附件吗？")) {
                $.ajax({
                    url: '/delete_attachment',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        attachment_id: attachmentId,
                        post_id: postId
                    }),
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('删除失败，请稍后重试。');
                    }
                });
            }
        });
    });


//导航标识，按钮时触发二级跳转
$(".category-btn").on("click", function() {
    var category = $(this).data("category"); //获取分类
    window.location.href = `/category.html?category=${encodeURIComponent(category)}&page=1`; //传递当前分类和第一页
});
</script>
</body>

</html>